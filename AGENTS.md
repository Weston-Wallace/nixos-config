# AGENTS.md - Coding Agent Instructions

This is a personal NixOS configuration repository using Nix Flakes. It
declaratively defines the entire system and user environment for a single
machine: a Framework 16-inch AMD AI 300 series laptop with hostname
**nullrunner**, owned by user **westonw**.

The entire codebase is written in the **Nix language**. There are no other
build systems, package managers, or application-level source files.

## Architecture

```
flake.nix                        # Entrypoint: inputs + single output (nixosConfigurations.nullrunner)
hosts/nullrunner/
  default.nix                    # System-level NixOS config (boot, networking, hardware, Stylix, etc.)
  hardware-configuration.nix     # Auto-generated by nixos-generate-config -- DO NOT MODIFY
wallpapers/                      # Wallpaper images (committed directly, no LFS)
home/westonw/
  default.nix                    # Home Manager entrypoint (user packages, git, imports)
  hyprland.nix                   # Hyprland window manager settings
  hyprlock.nix                   # Lock screen + idle daemon config
  waybar.nix                     # Status bar config + embedded CSS
  wofi.nix                       # App launcher config + embedded CSS
  mako.nix                       # Notification daemon config
  nixvim/
    default.nix                  # Nixvim entrypoint (options, colorscheme)
    plugins.nix                  # Editor plugins (telescope, nvim-tree, treesitter, etc.)
    lsp.nix                      # LSP servers + formatting (conform-nvim)
    completion.nix               # nvim-cmp + LuaSnip
    keymaps.nix                  # Editor key bindings
```

Home Manager is integrated as a NixOS module (not standalone), so a single
rebuild command handles both system and user configuration.

## Build / Rebuild Commands

There is no Makefile, justfile, or CI pipeline. All operations use Nix CLI.

**Rebuild commands require `sudo` and will not work in agent sandboxes.**
The user will run these manually. Agents should focus on editing files
correctly and using the validation commands below to check their work.

```bash
# Rebuild and switch (the primary "build" command -- user runs manually)
sudo nixos-rebuild switch --flake ~/nixos-config#nullrunner

# Dry-run build (user runs manually)
sudo nixos-rebuild dry-build --flake ~/nixos-config#nullrunner
```

### Validation commands agents CAN run

```bash
# Check flake evaluation -- catches syntax errors, missing files, type mismatches
nix flake check

# Update all flake inputs to latest versions
nix flake update --flake ~/nixos-config

# Format all Nix files (if formatter is wired into flake outputs)
nix fmt
```

**Use `nix flake check` as your primary validation step after making changes.**
There is no test framework. The real "test" is a successful `nixos-rebuild switch`,
but `nix flake check` catches most errors without requiring sudo.

## Formatting

- **Formatter:** `nixfmt` (the official RFC 166 Nix formatter). Configured in
  the editor via nixd LSP and conform-nvim for format-on-save.
- **No standalone linters** (statix, deadnix) are configured in the repo.
- **No `.editorconfig`**, treefmt config, or pre-commit hooks exist.

## Code Style Guidelines

### Indentation and Whitespace

- **2 spaces** for indentation. No tabs, ever.
- Lines generally kept under ~100 characters (no strict enforcement).
- One blank line between logical sections within a file.
- Semicolons terminate every attribute: `foo = "bar";`
- Closing braces get their own line, aligned with the parent: `};`

### Module Function Signature

Every `.nix` file (except `flake.nix`) uses the standard NixOS/Home Manager
module pattern with this argument order:

```nix
{ config, pkgs, lib, ... }:
```

Add `inputs` after `lib` only when flake inputs are needed:

```nix
{ config, pkgs, lib, inputs, ... }:
```

### Imports

Place `imports` as the first attribute in the returned attribute set.
One import per line, grouped by category with comments:

```nix
imports = [
    # Desktop environment (Phase 5)
    ./hyprland.nix
    ./waybar.nix
    # Editor (Phase 6)
    inputs.nixvim.homeModules.nixvim
    ./nixvim
];
```

### Attribute Sets and Package Lists

- **Dot-path notation** for simple settings: `boot.loader.systemd-boot.enable = true;`
- **Nested attribute sets** for groups (opening `{` on same line as parent):
  ```nix
  hardware.graphics = {
      enable = true;
      enable32Bit = true;
  };
  ```
- **`with pkgs;`** scoping for package lists; one package per line for long
  lists, grouped with category comments. Short lists on one line are fine.

### let Bindings

Place `let` blocks between the function signature and the returned attrset.
Omit `let` entirely when no local bindings are needed.

### Comments

- **Line comments only** (`#`). No block comments.
- **Section dividers** use Unicode box-drawing em-dash characters:
  ```nix
  # ── Section Name ─────────────────────────────────────────────────────────────
  ```
  The divider line extends to approximately column 80.
- Short explanatory comments above or inline with the relevant setting.
- Focus on "why" rather than restating "what."

### Nix Idioms Used

- `inherit` for concise argument passing: `inherit system;`
- `lib.mkForce` to override Stylix auto-generated values.
- `lib.mkDefault` only in `hardware-configuration.nix`.
- No `lib.mkIf`, `lib.mkMerge`, `lib.mkOption`, or custom module options.
- No custom packages, overlays, or derivations. All packages from nixpkgs or flake inputs.
- All flake inputs that depend on nixpkgs use `inputs.nixpkgs.follows = "nixpkgs"`.

### Theming

Colors come from Stylix, accessed via `config.lib.stylix.colors` (base16).
Use `colors.withHashtag` for hex colors in CSS/config strings. Helper
functions (e.g., `rgba`, `rgb`) are defined in `let` blocks when needed.
The theme is **Catppuccin Mocha** applied globally.

**Wallpapers** are stored as image files in `wallpapers/` at the repo root
and committed directly (jj/git LFS is not used -- typical wallpapers are
well under 1 MB). The active wallpaper is set in `hosts/nullrunner/default.nix`
via `stylix.image = ../../wallpapers/<filename>;`. To switch wallpapers, add
the new image to `wallpapers/` and update that path.

### File and Directory Naming

- All lowercase. Hyphens as separators where needed: `hardware-configuration.nix`
- Each directory has a `default.nix` as its entry point (idiomatic Nix).
- Host directories named after hostname: `hosts/nullrunner/`
- User directories named after username: `home/westonw/`
- Application configs named after the application: `hyprland.nix`, `waybar.nix`
- Concern-based names within nixvim: `lsp.nix`, `plugins.nix`, `keymaps.nix`

### Error Handling

No explicit error handling. The NixOS module system provides validation.
No `assert`, `throw`, or `builtins.abort` usage.

## Critical Warnings

- **NEVER modify `hardware-configuration.nix`** -- it is auto-generated.
- **NEVER change `system.stateVersion`** or `home.stateVersion` -- these must
  stay at `"25.11"` regardless of future NixOS upgrades.
- **No secrets** are stored in this repo. Do not commit API keys, passwords,
  or SSH private keys. No secrets management tool (agenix, sops-nix) is
  configured.

## Critical Maintenance Rule

**Keep this file up to date.** When you add new files, change the directory
structure, introduce new patterns, add flake inputs, or make any other
significant change to the repo, update the relevant sections of this
AGENTS.md in the same changeset. Future agents (including yourself in later
sessions) rely on this file being accurate.
